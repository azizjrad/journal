<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üî• Live Authentication Test</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        padding: 20px;
        background: #f8f9fa;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
      }
      .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 20px 0;
        padding: 20px;
      }
      .result {
        margin: 15px 0;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        padding: 12px 24px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .test-btn {
        background: #28a745;
      }
      .test-btn:hover {
        background: #1e7e34;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üî• Live Authentication Test</h1>
      <p>Testing the new authentication system on port 3014</p>

      <div class="card">
        <h3>Quick Login Test</h3>
        <button onclick="testLogin()" class="test-btn">
          üöÄ Test Login with admin2025
        </button>
        <button onclick="testCSRF()">üõ°Ô∏è Test CSRF Token</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
      </div>

      <div id="results"></div>
    </div>

    <script>
      function addResult(title, type, message, data = null) {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `card result ${type}`;
        div.innerHTML = `
                <h4>${title}</h4>
                <p>${message}</p>
                ${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ""}
            `;
        results.appendChild(div);
        div.scrollIntoView({ behavior: "smooth" });
      }

      function clearResults() {
        document.getElementById("results").innerHTML = "";
      }

      async function testCSRF() {
        try {
          addResult("CSRF Test", "info", "üîÑ Testing CSRF token generation...");

          const response = await fetch("/api/csrf-token");
          const data = await response.json();

          if (response.ok && data.csrfToken) {
            addResult(
              "CSRF Test",
              "success",
              "‚úÖ CSRF tokens working correctly!",
              {
                tokenLength: data.csrfToken.length,
                tokenPreview: data.csrfToken.substring(0, 20) + "...",
                success: data.success,
              }
            );
          } else {
            addResult(
              "CSRF Test",
              "error",
              "‚ùå CSRF token generation failed",
              data
            );
          }
        } catch (error) {
          addResult(
            "CSRF Test",
            "error",
            `‚ùå CSRF test error: ${error.message}`
          );
        }
      }

      async function testLogin() {
        try {
          addResult("Login Test", "info", "üîÑ Starting complete login test...");

          // Step 1: Get CSRF token
          const csrfResponse = await fetch("/api/csrf-token");
          if (!csrfResponse.ok) {
            throw new Error("Failed to get CSRF token");
          }
          const csrfData = await csrfResponse.json();

          addResult("Step 1", "success", "‚úÖ CSRF token obtained", {
            tokenLength: csrfData.csrfToken.length,
          });

          // Step 2: Attempt login
          const loginResponse = await fetch("/api/admin/login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRF-Token": csrfData.csrfToken,
            },
            body: JSON.stringify({ password: "admin2025" }),
            credentials: "include",
          });

          const loginData = await loginResponse.json();

          if (loginResponse.ok) {
            addResult(
              "Step 2 - LOGIN SUCCESS! üéâ",
              "success",
              "üéâ AUTHENTICATION WORKING! Login successful!",
              {
                status: loginResponse.status,
                token: loginData.token
                  ? loginData.token.substring(0, 30) + "..."
                  : "No token",
                user: loginData.user,
                message: loginData.message,
              }
            );

            // Test accessing dashboard
            setTimeout(() => {
              addResult(
                "Next Step",
                "info",
                "‚úÖ You can now access the admin dashboard!",
                {
                  dashboardUrl: "/admin/dashboard",
                  loginPageUrl: "/admin/login",
                }
              );
            }, 1000);
          } else {
            addResult(
              "Step 2 - Login Failed",
              "error",
              `‚ùå Login failed: ${loginData.error || "Unknown error"}`,
              {
                status: loginResponse.status,
                response: loginData,
              }
            );
          }
        } catch (error) {
          addResult(
            "Login Test Error",
            "error",
            `‚ùå Test failed: ${error.message}`
          );
        }
      }

      // Auto-test when page loads
      window.addEventListener("load", () => {
        setTimeout(() => {
          testCSRF();
        }, 1000);
      });
    </script>
  </body>
</html>
